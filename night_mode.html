<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>夜モード | ランプシャッター</title>
<style>
html,body{margin:0;height:100%;background:#000;overflow:hidden}
#wrap{position:fixed;inset:0}
video#pv{position:absolute;inset:0;object-fit:cover;width:100%;height:100%;
         filter:brightness(1.2) contrast(1.2);transform:none}
.roi{position:absolute;top:12px;right:12px;width:42%;height:11%;border:3px dashed rgba(255,255,0,.9);border-radius:8px}
.badge{position:absolute;top:10px;left:10px;padding:8px 14px;border-radius:10px;font-weight:900;font-size:28px;color:#fff}
.ok{background:#16c65b}
.ng{background:#e03434}
.shutter{position:absolute;left:50%;bottom:8vh;transform:translateX(-50%);
         width:min(120px,28vw);height:min(120px,28vw);border-radius:22px;background:rgba(0,0,0,.25);
         display:grid;place-items:center;backdrop-filter:blur(4px)}
.shutter img{width:78%;height:78%;object-fit:contain;pointer-events:none}
</style>
</head>
<body>
<div id="wrap">
  <video id="pv" playsinline autoplay muted></video>
  <div id="roi" class="roi" aria-hidden="true"></div>
  <div id="badge" class="badge">…</div>
  <button id="shot" class="shutter" aria-label="撮影">
    <img src="assets/instant_camera.png" alt="">
  </button>
</div>

<script type="module">
const pv=document.getElementById('pv');
const badge=document.getElementById('badge');
const roi=document.getElementById('roi');
const shot=document.getElementById('shot');

const stream=await navigator.mediaDevices.getUserMedia({
  video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}},audio:false});
pv.srcObject=stream;

const work=document.createElement('canvas'),wctx=work.getContext('2d',{willReadFrequently:true});
const save=document.createElement('canvas'),sctx=save.getContext('2d');

const ROI_RATE={x:0.58,y:0.05,w:0.38,h:0.14};

function getRect(){
  const v=pv.getBoundingClientRect(), vw=pv.videoWidth, vh=pv.videoHeight;
  return {x:vw*ROI_RATE.x,y:vh*ROI_RATE.y,w:vw*ROI_RATE.w,h:vh*ROI_RATE.h};
}

function judge(){
  if(!(pv.videoWidth&&pv.videoHeight))return;
  const r=getRect();work.width=r.w;work.height=r.h;
  wctx.drawImage(pv,r.x,r.y,r.w,r.h,0,0,r.w,r.h);
  const im=wctx.getImageData(0,0,r.w,r.h).data;
  let R=0,G=0,cnt=0;
  for(let y=0;y<r.h;y+=6){
    for(let x=0;x<r.w;x+=6){
      const i=(y*r.w+x)*4;const rr=im[i],gg=im[i+1],bb=im[i+2];
      const sum=rr+gg+bb||1;const rn=rr/sum,gn=gg/sum;
      if(rr>60&&rn>0.35&&(rr-gg)>15&&(rr-bb)>15)R++;
      if(gg>50&&gn>0.35&&(gg-rr)>8&&(gg-bb)>8)G++;
      cnt++;
    }
  }
  const ok=G>R;
  badge.className='badge '+(ok?'ok':'ng');
  badge.textContent=ok?'OK':'NG?';
  return ok;
}
setInterval(judge,33);

shot.onclick=async()=>{
  const ok=judge();
  const vw=pv.videoWidth,vh=pv.videoHeight;
  save.width=vw;save.height=vh;
  sctx.drawImage(pv,0,0,vw,vh);
  const now=new Date(),ts=now.toISOString().replace(/[-:T]/g,'').slice(0,14);
  const text=ok?'OK':'NG?';
  sctx.font=`${Math.round(vh*0.04)}px system-ui`;sctx.fillStyle='#fff';sctx.strokeStyle='rgba(0,0,0,.6)';sctx.lineWidth=6;
  sctx.strokeText(`${ts} ${text}`,24,vh-24);sctx.fillText(`${ts} ${text}`,24,vh-24);
  const fname=`${ts}_${text}.jpg`;
  const blob=await new Promise(r=>save.toBlob(r,'image/jpeg',0.92));
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=fname;a.click();
  if(ok){new Audio('assets/ok_voice_female.mp3').play().catch(()=>{});}
};
</script>
</body>
</html>
