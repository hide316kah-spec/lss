<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>夜モード - ランプシャッター</title>
<style>
body { margin: 0; background-color: #000; overflow: hidden; text-align:center; }
video { width: 100%; height: auto; }
canvas { position: absolute; top: 0; left: 0; }
#status {
  position: absolute; top: 10px; left: 10px;
  color: white; font-size: 26px; padding: 8px 16px;
  border-radius: 8px; font-weight: bold;
}
#capture-btn {
  position: absolute; bottom: 40px; left: 50%;
  transform: translateX(-50%);
  width: 120px;
}
</style>
</head>
<body>
<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>
<div id="status">判定中...</div>
<img id="capture-btn" src="assets/camera_icon.png" onclick="captureManual()">
<audio id="ok-sound" src="assets/ok_sound.mp3"></audio>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const statusDiv = document.getElementById('status');
let autoCaptured = false;

navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment" }, audio: false
}).then(stream => {
  video.srcObject = stream;
  video.play();
  requestAnimationFrame(loop);
});

function loop() {
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const {ok} = analyzeFrame();
    updateStatus(ok);
    if (ok && !autoCaptured) {
      autoCaptured = true;
      captureAuto();
      setTimeout(()=>autoCaptured=false, 3000);
    }
  }
  requestAnimationFrame(loop);
}

// ▼ 夜モードの閾値（甘め設定）
function analyzeFrame() {
  const roi = { x: canvas.width*0.58, y: canvas.height*0.05,
                w: canvas.width*0.38, h: canvas.height*0.14 };
  const img = ctx.getImageData(roi.x, roi.y, roi.w, roi.h).data;
  let red=0, green=0;
  for (let i=0; i<img.length; i+=4*6) {
    const r=img[i], g=img[i+1], b=img[i+2];
    const rn=r/(r+g+b+1), gn=g/(r+g+b+1);
    if (r>70 && rn>0.35 && r-g>14 && r-b>14) red++;
    if (g>60 && gn>0.35 && g-r>8 && g-b>8) green++;
  }
  const total=img.length/4/6;
  const redRate=red/total, greenRate=green/total;
  return {ok: (redRate<0.01 && greenRate>=0.01)};
}

function updateStatus(ok) {
  if (ok) { statusDiv.textContent="OK"; statusDiv.style.background="#00CC00"; }
  else { statusDiv.textContent="NG?"; statusDiv.style.background="#CC0000"; }
}

function captureAuto() {
  document.getElementById("ok-sound").play();
  flash();
  saveImage("OK");
}

function captureManual() {
  flash();
  saveImage(statusDiv.textContent);
}

function flash() {
  const flashDiv=document.createElement("div");
  flashDiv.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:white;opacity:0.8;z-index:9999;";
  document.body.appendChild(flashDiv);
  setTimeout(()=>flashDiv.remove(),100);
}

function saveImage(result) {
  const outCanvas=document.createElement("canvas");
  outCanvas.width=canvas.width; outCanvas.height=canvas.height;
  const octx=outCanvas.getContext("2d");
  octx.drawImage(video,0,0,canvas.width,canvas.height);
  octx.fillStyle="white";
  octx.font="40px sans-serif";
  const now=new Date().toISOString().replace(/[-T:\.Z]/g,"");
  const label=`${now}_${result}`;
  octx.fillText(label,40,60);
  outCanvas.toBlob(blob=>{
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`${label}.jpg`;
    a.click();
  },"image/jpeg",0.9);
}
</script>
</body>
</html>
